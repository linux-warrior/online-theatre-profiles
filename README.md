# online-theatre-profiles

Реализация профилей пользователей для онлайн-кинотеатра. Ссылка на оригинальный репозиторий проекта:
https://github.com/ishar8520/online-theatre/.

## Архитектура проекта

При разработке технического решения была использована микросервисная архитектура. За основу были взяты
ряд сервисов из первоначального проекта:

* Сервис авторизации.
* Сервис выдачи контента.
* Сервис ETL.
* Сервис функциональных тестов.

## Профили пользователей

В проекте был реализован следующий функционал:

* API для управления профилями пользователей.
* API для добавления понравившихся фильмов в профиль.
* API для установки пользовательского рейтинга фильмов.
* API для создания рецензий на фильмы.
* В сервисе выдачи контента при просмотре сведений о фильме добавлено отображение пользовательского
  рейтинга и отзывов.
* Добавлена возможность просмотра профилей и связанных с ними артефактов в админке Django.

## Запуск проекта в Docker Compose

### Запуск в режиме продакшн

```shell
$ ./run_server.sh
```

### Запуск в режиме для разработчиков (с использованием Docker Compose Watch)

```shell
$ ./run_server.sh dev
```

## Запуск тестов в Docker Compose

### Стандартный запуск тестов

```shell
$ ./run_tests.sh
```

### Запуск тестов с указанием версии Python

```shell
$ PYTHON_VERSION=3.12 ./run_tests.sh
```

### Запуск тестов с использованием Docker Compose Watch

В одном окне терминала стартуем сервисы в watch mode:

```shell
$ ./run_tests.sh watch
```

Когда все контейнеры с сервисами запустятся, в другом окне терминала выполняем уже сами тесты:

```shell
$ ./run_tests.sh tests
```

## Статический анализ кода

### Стандартный запуск в Docker Compose

В качестве первого параметра скрипта необходимо передать название вида статического анализа.
Если второй параметр не задан, то соответствующая команда будет запущена в контейнере каждого
сервиса из Compose file, в котором она поддерживается:

```shell
$ ./run_lint.sh mypy
```

Доступны следующие названия команд статического анализа:

* `mypy`
* `ruff`

В качестве второго параметра можно указать название конкретного сервиса, код которого необходимо
проанализировать:

```shell
$ ./run_lint.sh mypy movies
```

Результаты статического анализа для каждого сервиса сохраняются в соответствующий том Docker,
который монтируется на хост-систему в директорию _.lint_.

### Запуск с использованием Docker Compose Watch

В одном окне терминала:

```shell
$ ./run_lint.sh watch
```

В другом окне терминала:

```shell
$ ./run_lint.sh watch mypy
```

Также возможен статический анализ кода конкретного сервиса:

```shell
$ ./run_lint.sh watch mypy movies
```

## Описание сервисов проекта

### Сервис авторизации

http://127.0.0.1:8000/auth/api/openapi

Сервис авторизации предназначен для хранения пользователей и их прав доступа. Через API данного сервиса
происходит аутентификация и авторизация во время выполнения HTTP-запросов ко всем остальным сервисам проекта.

Для разграничения прав пользователей реализована следующая логика:

* Роли (Roles): пользователю можно назначить одну или несколько ролей.
* Разрешения (Permissions): к каждой роли можно привязать одно или несколько разрешений. Каждому разрешению
  сопоставлена некоторая уникальная строка (permission code).

При запросе информации о пользователе из методов API сервиса все доступные права пользователя, связанные с
его ролями, объединяются в один список и возвращаются в виде массива кодов разрешений.

### Сервис профилей пользователей

http://127.0.0.1:8000/profiles/api/openapi

Сервис профилей используется для работы со следующими видами сущностей:

* Профили пользователей.
* Понравившиеся фильмы.
* Пользовательские рейтинги фильмов.
* Рецензии пользователей на фильмы.

В методах API сервиса применяется следующий механизм разграничения прав доступа пользователей:

* По умолчанию пользователь может просматривать, создавать, редактировать и удалять только те сущности,
  которые относятся к его UUID.
* Суперпользователям, а также пользователям, у которых есть права с кодом `profiles.admin`, предоставляется
  неограниченный доступ ко всем сущностям.
* Обращаться к методам API только для чтения, возвращающим сводную информацию по конкретному фильму
  (пользовательский рейтинг и отзывы на фильм), разрешено всем пользователям без ограничений.

#### Profiles API

http://127.0.0.1:8000/profiles/api/openapi#/profiles

Предоставляет методы CRUD для управления профилями пользователей. Профиль включает в себя следующие
сведения:

* ФИО
* Номер телефона

В целях безопасности номер телефона хранится в БД в зашифрованном виде.

#### Favorites API

http://127.0.0.1:8000/profiles/api/openapi#/favorites

Предоставляет методы CRUD для добавления понравившихся фильмов в профиль.

#### Ratings API

http://127.0.0.1:8000/profiles/api/openapi#/ratings

Предоставляет следующие методы API:

* CRUD для установки пользовательского рейтинга фильмам.
* Метод API, возвращающий среднее значение рейтинга для конкретного фильма.

#### Reviews API

http://127.0.0.1:8000/profiles/api/openapi#/reviews

Предоставляет следующие методы API:

* CRUD для рецензий на фильмы.
* Метод API, возвращающий список отзывов на конкретный фильм, а также рассчитывающий
  среднее значение рейтинга, указанного в отзывах.

### Сервис администратора профилей

http://127.0.0.1:8000/profiles-admin/admin/

Данный сервис содержит админку Django, в которой администраторам предоставляется возможность просмотра
содержимого таблиц БД сервиса профилей. Под администраторами подразумеваются следующие группы пользователей
сервиса авторизации:

* Суперпользователи.
* Пользователи с правами доступа с кодом `profiles.admin`.

### Сервис выдачи контента

http://127.0.0.1:8000/api/openapi

Сервис предоставляет возможность полнотекстового поиска фильмов, жанров и персон в Elasticsearch. В ответ
метода API сервиса, возвращающего подробную информацию о фильме (`GET /api/v1/films/{uuid}`), были добавлены
пользовательский рейтинг фильма и отзывы.

### Сервис ETL

Данный сервис осуществляет выгрузку фильмов, жанров и персон из PostgreSQL в Elasticsearch сервиса выдачи
контента.
